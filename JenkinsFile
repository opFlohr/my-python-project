pipeline { 
agent any 
environment { 
DOCKER_USER = 'opflohr' 
}
stages { 
  stage('Checkout') {
    steps {
           git branch: 'main', url: 'https://github.com/opFlohr/my-python-project.git'
         }
  }
stage('Flake8') { 
steps { 
 echo 'Executing flake8 ...' 
 sh 'python3 --version'
 sh 'python3 -m flake8 --version'
 sh 'python3 -m flake8 . --count --show-source --statistics || true'
} 
} 
stage('Test') { 
steps { 
echo 'Executing pytest ...' 
sh 'pytest | tee report.txt'
} 
} 
stage('Deploy') { 
  steps { 
  echo 'Deploying...' 
  withCredentials([string(credentialsId: 'jcj-DOCKER_PASSWORD', variable: 'DOCKER_PASS')]) 
  { 
    sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin' 
  } 
  // Construire l'image Docker avec le BUILD_NUMBER de Jenkins
  sh 'docker build -t opflohr/my-python-app:$BUILD_NUMBER .'

  // Se connecter à Docker Hub en utilisant le token d'accès 
  sh 'docker login -u $DOCKER_LOGIN -p $DOCKER_PASS'

  // Pousser l'image sur Docker Hub
  sh 'docker push opflohr/my-python-app:$BUILD_NUMBER'
  
  } 
} 
}
}
